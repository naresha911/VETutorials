!function(a){AnsPress.loadTemplate("list"),AnsPress.models.Filter=Backbone.Model.extend({defaults:{active:!1,label:"",value:""}}),AnsPress.collections.Filters=Backbone.Collection.extend({model:AnsPress.models.Filter}),AnsPress.activeListFilters=a("#ap_current_filters").length>0?JSON.parse(a("#ap_current_filters").html()):{},AnsPress.views.Filter=Backbone.View.extend({id:function(){return this.model.id},nameAttr:function(){return this.multiple?"filters["+this.model.get("key")+"][]":"filters["+this.model.get("key")+"]"},isActive:function(){if(this.active)return this.active;if(!_.isEmpty(AnsPress.activeListFilters)){var a=this.model.get("key"),b=this.model.get("value");if(AnsPress.activeListFilters[a]&&(!this.multiple&&AnsPress.activeListFilters[a]==b||this.multiple&&_.contains(AnsPress.activeListFilters[a],b)))return this.active=!0,!0}return this.active=!1,!1},className:function(){return this.isActive()?"active":""},template:'<label><input type="checkbox" name="{{name}}" value="{{value}}"<# if(active){ #> checked="checked"<# } #>/><i class="apicon-check"></i>{{label}}</label>',initialize:function(a){this.model=a.model,this.multiple=a.multiple,this.listenTo(this.model,"remove",this.removed)},events:{"change input":"clickFilter"},render:function(){var a=_.template(this.template),b=this.model.toJSON();return b.name=this.nameAttr(),b.active=this.isActive(),this.$el.html(a(b)),this},clickFilter:function(b){b.preventDefault(),this.multiple?a('input[name="'+a(b.target).attr("name")+'"][value="'+a(b.target).attr("value")+'"]').not(b.target).remove():a('input[name="'+a(b.target).attr("name")+'"]').not(b.target).remove(),a(b.target).closest("form").submit()},removed:function(){this.remove()}}),AnsPress.views.Filters=Backbone.View.extend({className:"ap-dropdown-menu",searchTemplate:'<div class="ap-filter-search"><input type="text" search-filter placeholder="'+aplang.search+'" /></div>',template:'<button class="ap-droptogg apicon-x"></button><filter-items></filter-items>',initialize:function(a){this.model=a.model,this.multiple=a.multiple,this.filter=a.filter,this.nonce=a.nonce,this.listenTo(this.model,"add",this.added)},events:{"keypress [search-filter]":"searchInput"},renderItem:function(a){var b=new AnsPress.views.Filter({model:a,multiple:this.multiple});this.$el.find("filter-items").append(b.render().$el)},render:function(){var a=this;return this.multiple&&this.$el.append(this.searchTemplate),this.$el.append(this.template),this.model.each(function(b){a.renderItem(b)}),this},search:function(a,b){var c=this,d={__nonce:this.nonce,ap_ajax_action:"load_filter_"+this.filter,search:a,filter:this.filter};AnsPress.showLoading(b),AnsPress.ajax({data:d,success:function(a){if(AnsPress.hideLoading(b),a.success){for(c.nonce=a.nonce;model=c.model.first();)model.destroy();c.model.add(a.items)}}})},searchInput:function(b){var c=this;clearTimeout(this.searchTO),this.searchTO=setTimeout(function(){c.search(a(b.target).val(),b.target)},600)},added:function(a){this.renderItem(a)}}),AnsPress.views.List=Backbone.View.extend({el:"#ap-filters",initialize:function(){},events:{"click [ap-filter]:not(.loaded)":"loadFilter","click #ap-filter-reset":"resetFilter"},loadFilter:function(b){b.preventDefault();AnsPress.showLoading(b.currentTarget);var c=a.parseJSON(a(b.currentTarget).attr("ap-query"));c.ap_ajax_action="load_filter_"+c.filter,AnsPress.ajax({data:c,success:function(d){AnsPress.hideLoading(b.currentTarget),a(b.currentTarget).addClass("loaded");var e=new AnsPress.collections.Filters(d.items),f=new AnsPress.views.Filters({model:e,multiple:d.multiple,filter:c.filter,nonce:d.nonce});a(b.currentTarget).after(f.render().$el)}})},resetFilter:function(b){a('#ap-filters input[type="hidden"]').remove(),a('#ap-filters input[type="checkbox"]').prop("checked",!1)}}),new AnsPress.views.List}(jQuery);