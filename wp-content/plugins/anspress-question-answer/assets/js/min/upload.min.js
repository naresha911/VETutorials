var uploadsModel;!function(a){AnsPress.models.Upload=Backbone.Model.extend({defaults:{id:"",oldId:"",fileName:"",type:"",fileSize:"",uploaded:!0,failed:!1,url:"",nonce:""}}),AnsPress.collections.Uploads=Backbone.Collection.extend({model:AnsPress.models.Upload}),AnsPress.views.Upload=Backbone.View.extend({idAttribute:"id",template:a("#ap-upload-template").html(),id:function(){return this.model.get("id")},tagName:"div",className:"ap-upload-item",initialize:function(a){this.model=a.model,this.model.on("change:failed",this.uploadFailed,this),this.model.on("change:id",this.idChanged,this),this.model.on("change",this.render,this),this.listenTo(AnsPress,"apUploadProgress",this.progress),this.listenTo(this.model,"remove",this.removeEl)},events:{"click .insert-to-post":"insertImage","click .apicon-trashcan":"removedUpload"},render:function(){var b=a(this.template+'<input name="ap-medias[]" value="'+this.model.get("id")+'" type="hidden">');return this.model.get("uploaded")&&this.$el.addClass("done"),this.model.get("isImage")&&this.$el.addClass("is-image"),b.filter(".ap-upload-name").text(this.model.get("fileName")+" ("+this.model.get("fileSize")+")"),this.$el.html(b),this},uploadFailed:function(){this.$el.removeClass("done").addClass("failed")},idChanged:function(){this.$el.attr("id",this.model.get("id")),this.$el.find("input").val(this.model.get("id"))},removedUpload:function(b){b.preventDefault();var c=this;AnsPress.ajax({data:{ap_ajax_action:"delete_attachment",attachment_id:c.model.get("id"),__nonce:c.model.get("nonce")},success:function(b){b.success&&(a("#"+c.model.get("id")).remove(),setTimeout(function(){AnsPress.uploader.removeFile(c.model.get("id"))},400),"undefined"!=typeof tinyMCE&&(tinyMCE.activeEditor.dom.remove(tinymce.activeEditor.dom.select('img[src="'+c.model.get("url")+'"]')),tinyMCE.activeEditor.execCommand("mceInsertContent",!1,"")))}})},insertImage:function(a){a.preventDefault(),this.model.get("isImage")&&b(this.model.get("url"),this.model.get("id"))},progress:function(a){this.model.get("id")===a.id&&this.$el.find(".ap-progress").css("width",a.per+"%")},removeEl:function(){console.log("remove"),this.$el.remove()}}),AnsPress.views.Uploads=Backbone.View.extend({el:"#ap-upload",initialize:function(a){this.model=a.model,this.model.on("add",this.adddedUplaod,this),this.listenTo(AnsPress,"uploadsRemoved",this.removeAll)},renderItem:function(a){var b=new AnsPress.views.Upload({model:a});this.$el.append(b.render().$el)},render:function(){var a=this;return this.model&&this.model.each(function(b){a.renderItem(b)}),this},adddedUplaod:function(a){this.renderItem(a)},removeAll:function(){var a=this;this.model&&this.model.each(function(b,c){a.model.remove(b)})}});var b=function(a,b){var c='<img src="'+a+'" id="'+b+'" />';"undefined"!=typeof tinyMCE?tinyMCE.activeEditor.execCommand("mceInsertContent",!1,c):jQuery(".wp-editor-area").val(jQuery(".wp-editor-area").val()+c)};uploadsModel=new AnsPress.collections.Uploads(JSON.parse(a("#ap-uploads-data").html()));var c=new AnsPress.views.Uploads({model:uploadsModel});c.render(),wpUploaderInit.browse_button="pickfiles",wpUploaderInit.container="ap-upload",wpUploaderInit.init={FilesAdded:function(b,c){var d=!1;a("#ap-upload-template").html();plupload.each(c,function(a){return b.files.length>b.settings.maxfiles?(d||alert(aplang.attached_max),b.removeFile(a),void(d=!0)):(uploadsModel.add({id:a.id,oldId:a.id,fileName:a.name,type:a.type,fileSize:plupload.formatSize(a.size),url:"",nonce:"",uploaded:!1}),void AnsPress.uploader.start())})},UploadProgress:function(a,b){AnsPress.trigger("apUploadProgress",{id:b.id,per:b.percent})},FileUploaded:function(a,c,d){var e=c.id,f=AnsPress.ajaxResponse(d.response);f.success&&(uploadsModel.get(e).set({id:f.attachment_id,nonce:f.delete_nonce,done:f.success,isImage:f.is_image,url:f.attachment_url,uploaded:!0}),f.is_image&&b(f.attachment_url,f.attachment_id)),f.success||(AnsPress.trigger("snackbar",f),uploadsModel.get(c.id).set({failed:!0}),a.removeFile(c))},Error:function(a,b){b.code===-600&&AnsPress.trigger("snackbar",{success:!1,snackbar:{message:aplang.file_size_error}})},FilesRemoved:function(){AnsPress.trigger("uploadsRemoved")}},AnsPress.uploader=new plupload.Uploader(wpUploaderInit),AnsPress.uploader.init(),a(".ap-field-description").on("drag dragstart dragenter dragover",function(b){a(this).addClass("dragging")}),a(".ap-field-description").on("dragend  dragleave drop",function(b){a(this).removeClass("dragging")})}(jQuery);